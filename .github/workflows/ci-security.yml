name: CI Security (Semgrep + pip-audit)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install semgrep pip-audit jq

      - name: Run Semgrep
        run: |
          semgrep --config=p/ci --json > semgrep.json || true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-json
          path: semgrep.json

      - name: Run pip-audit and create valid SARIF
        run: |
          # Пытаемся создать JSON-отчёт
          pip-audit -f json -o pip-audit.json || true

          # Если pip-audit.json пустой или содержит текст, создаём пустой JSON
          if ! jq empty pip-audit.json 2>/dev/null; then
            echo "[]" > pip-audit.json
          fi

          # Преобразуем в корректный SARIF
          jq -n --argjson runs "[{ \"tool\": {\"driver\": {\"name\": \"pip-audit\"}}, \"results\": ($(cat pip-audit.json)) }]" \
            '{ "$schema": "https://json.schemastore.org/sarif-2.1.0.json", "version": "2.1.0", "runs": $runs }' > pip-audit.sarif

      - name: Upload pip-audit SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif

      - name: Upload pip-audit SARIF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-sarif
          path: pip-audit.sarif
