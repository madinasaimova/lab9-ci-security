name: CI Security (Semgrep + pip-audit)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install semgrep pip-audit jq

      # --- SEMGREP ---
      - name: Run Semgrep
        run: |
          semgrep --config=p/ci --json > semgrep.json || echo "Semgrep finished with non-zero exit"

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-json
          path: semgrep.json

      # --- PIP-AUDIT ---
      - name: Run pip-audit and generate SARIF
        shell: bash
        run: |
          echo "Running pip-audit..."
          pip-audit -r requirements.txt -f json -o pip-audit.json || echo "pip-audit finished"

          # Проверяем, что JSON не пустой
          if [ ! -s pip-audit.json ]; then
            echo "No vulnerabilities found — creating empty SARIF"
            echo '{
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                "tool": { "driver": { "name": "pip-audit" } },
                "results": []
              }]
            }' > pip-audit.sarif
          else
            echo "Wrapping pip-audit JSON output into SARIF format"
            # Проверяем, является ли JSON массивом, если нет — оборачиваем в []
            CONTENT=$(cat pip-audit.json)
            if [[ $CONTENT != \[* ]]; then
              CONTENT="[$CONTENT]"
            fi

            echo '{
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                "tool": { "driver": { "name": "pip-audit" } },
                "results": '"$CONTENT"'
              }]
            }' > pip-audit.sarif
          fi

      - name: Upload pip-audit SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif

      - name: Upload pip-audit SARIF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-sarif
          path: pip-audit.sarif
